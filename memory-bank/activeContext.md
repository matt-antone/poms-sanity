# Active Context

## Current Focus

- **Backup System Implementation Complete:**
  - Comprehensive backup system for Sanity CMS is finalized and fully operational.
  - **API Route:** `nextjs-app/app/api/backup/route.ts` handles automated backups via both GET (cron jobs) and POST (manual) requests
  - **Archive Format:** Uses JSZip to create proper ZIP archives for easy extraction
  - **Dataset Export:** CLI-compatible Sanity export format for restoration with Sanity CLI
  - **Backup Types:** Daily (retain 7 days) and monthly (retain 6 months)
  - **Dataset Backup:** Exports all content data and media files in CLI-compatible format (no separate media backup needed)
  - **Storage:** Backups stored in Vercel Blob Storage with automatic cleanup
  - **Cron Job:** Configured in `vercel.json` to run daily at 3 AM UTC via GET request
  - **Security:** Protected with secret token authentication
  - **Environment Variables:** Uses `SANITY_PROJECT_ID`, `SANITY_DATASET`, `SANITY_API_TOKEN`, `BACKUP_SECRET`
  - **Naming Convention:** `{daily|monthly}_backup_YYYY-MM-DD.zip`
  - **CLI Restoration:** Exports include `data.ndjson`, `assets.json`, and all media files in correct folders for direct use with `sanity dataset import`
  - **Complete Dataset:** Main export includes all content documents, asset metadata, and actual media files
  - **Proper CLI Format:** NDJSON includes only content documents (no asset documents), asset files in `images/` and `files/` folders
- **Page Hero & Title Implementation Complete:** The `nextjs-app/app/[slug]/page.tsx` component now dynamically displays a hero image and page title/subtitle using the `PageHeader` component. This utilizes the `showHero`, `hero`, `heading`, `title`, and `subheading` fields from the Sanity page schema.
  - The `getPageQuery` in `nextjs-app/sanity/lib/queries/page.ts` was previously updated to fetch these new fields.
  - TypeScript types were regenerated by the user to include these fields in `GetPageQueryResult`.
  - The `sanityFetch` call in `page.tsx` was updated to use `typeof getPageQuery` for correct type inference.
  - The hero image uses `next/image` with `fill` and `object-cover`, and `priority`. Alt text defaults to page title if not provided.
  - The `PageHeader` component is used both within the hero section (if shown) and as a standalone header otherwise.
- **CSS/Theme Fixes for Nested Themes Complete:** User reported updates to `globals.css`, `theme.css`, and `nextjs-app/app/components/blocks/_classes.ts` to resolve display issues with nested themes.
- **Sanity Schema Update:** User reported updates to the page schema in the `studio/` directory (addition of `showHero` and `hero` fields, likely also `heading` and `subheading` previously or as part of this).
- **Loading Components Refactored:** All identified route-specific `loading.tsx` files (`app/blog/loading.tsx`, `app/[slug]/loading.tsx`, `app/blog/[slug]/loading.tsx`) have been updated to use the centralized `LoadingPage` spinner component from `app/components/ui/loading.tsx`.
- **Footer Component Implemented:** The `Footer.tsx` component in `nextjs-app/app/components/` has been successfully updated to fetch and display site settings (logo, title) and footer navigation links from Sanity.
- **`sanityFetch` Typing Resolved:** The correct TypeScript pattern for using `sanityFetch` (from `next-sanity`'s `defineLive`) has been identified and applied.
- **Resolved Stega Decoding Error:** The primary frontend error "Failed to decode stega for string..." has been resolved.
- **`stripChars` to `stegaClean` Refactor:** Systematically replaced the custom `stripChars` function with `stegaClean` from `@sanity/client/stega` across various block components.
  - Completed for: `BlockRenderer.tsx`, `TestimonialBlock.tsx`, `ContentBlock.tsx`, `BlockBGColor.tsx`, `GalleryBlock.tsx`.
  - `BentoBlock.tsx` had a related `GridCols` indexing issue which has been fixed.
  - `CallToActionBlock.tsx` was found to already use `stegaClean` for one field; `vAlign` option updated.
  - `AdvancedListBlock.tsx` has had its linter errors resolved after `stegaClean` application and other refactoring.
- **Sanity Image Query Consistency:** Updated the `pageBuilder` query in `nextjs-app/sanity/lib/queries/common.ts` for `carouselBlock` to ensure image assets are fetched consistently.
- **Ongoing (Lower Priority):** Investigating Sanity Visual Editing (`@sanity/visual-editing`) integration for "Unable to connect" errors. Nonce propagation for CSP and the "token in browser" warning are also known, less immediate issues.
- **Document recovery system implementation**
  - Added `deletedDocs.bin` singleton document type
  - Set up webhook for deletion tracking
  - Implemented custom UI components for recovery interface
  - Added document restoration capabilities
  - Created dedicated view for managing deleted documents
  - Implemented GROQ delta functions for operation filtering
  - Added custom components:
    - `DeletionLogItemComponent` for individual log entries
    - `DeletionLogInputComponent` for logs array management
    - `DeletedDocIdInputComponent` for ID display
  - Integrated user authentication for deletion tracking
  - Added automatic cleanup of restored documents
- **Webhook Management Implementation**
  - Using Sanity CLI for webhook management
  - Creating webhook for recycling bin functionality
  - Script location: `studio/scripts/create-recycle-bin-webhook.sh`
  - Environment variables required:
    - `SANITY_STUDIO_PROJECT_ID`
    - `SANITY_STUDIO_DATASET`
    - `SANITY_STUDIO_API_TOKEN`
  - Webhook configuration:
    - Tracks document deletions
    - Updates `deletedDocs.bin` singleton
    - Maintains deletion logs and document IDs
- **Webhook Creation Attempts**
  - Initial attempt using direct API calls failed with 404 errors
  - Attempted multiple API versions:
    - `v2021-06-07`
    - `v2021-03-25`
    - `v2025-05-06`
  - Attempted both `project` and `projects` in URL paths
  - All API-based approaches failed
  - Need to investigate Sanity CLI approach
- **Updated Backup System to Use Sanity CLI for Dataset Export (Current Session):**
  - Replaced API-based dataset export with Sanity CLI (`sanity dataset export`) for more comprehensive backups
  - Sanity CLI provides better export structure and includes all dataset files
  - Uses temporary directory for export then cleans up automatically
  - More reliable than the previous API approach
- **Updated Backup System to Use ZIP Format (Current Session):**
  - Replaced gzipped archive implementation with JSZip for proper ZIP file creation
  - Updated file extensions from `.gz` to `.zip` for better user experience
  - Enhanced extraction script to properly extract ZIP files with directory structure
  - ZIP files can now be opened with any standard ZIP tool (Finder, Windows Explorer, etc.)
  - Much more user-friendly than the previous custom gzipped format
- **Updated Backup System for CLI-Compatible Export Format (Current Session):**
  - Modified export function to create CLI-compatible format for Sanity CLI restoration
  - Exports include `export.ndjson` file that works with `sanity dataset import` command
  - Added README.md with restoration instructions in each backup ZIP
  - Structured export data to match Sanity CLI's expected format
  - Enables full dataset restoration using Sanity CLI tools
- **Updated Export Format for Proper Sanity CLI Import (Current Session):**
  - Modified export to include asset documents in the NDJSON file (not just content documents)
  - Asset files now stored in correct folders: `images/` for image assets, `files/` for file assets
  - Asset files named using asset `_id` (no file extension) as expected by Sanity CLI
  - NDJSON now contains all documents: content documents + asset documents
  - This matches the exact format that Sanity CLI expects for import
  - Should resolve "references non-existent document" errors during import
- **Fixed Export Format to Use NDJSON for CLI Import (Current Session):**
  - Changed export format from JSON to NDJSON (Newline Delimited JSON)
  - Sanity CLI expects `.ndjson` files for dataset import, not regular JSON
  - Each document is now on a separate line in the export file
  - This matches the exact format that Sanity CLI creates and expects
  - Restoration now works with: `sanity dataset import production export.ndjson --replace`
- **Resolved Sanity CLI Build Compatibility Issue (Current Session):**
  - Attempted to use Sanity CLI programmatically but encountered build errors in Next.js
  - CLI package imports esbuild modules incompatible with Next.js webpack configuration
  - Reverted to comprehensive Sanity API export that provides similar functionality
  - API approach exports documents, assets metadata, and dataset info in structured format
- **Updated Backup System to Include Media Files in Dataset Export (Current Session):**
  - Modified dataset export to include actual media files, not just metadata
  - Media files are now stored in `assets/` directory within the main dataset export
  - This matches the behavior of Sanity CLI dataset export
  - Separate media backup still created for redundancy
  - Complete dataset export now includes documents, assets metadata, and actual media files

## Recent Changes

- **Fixed Backup System Cron Job (Current Session):**
  - Updated `nextjs-app/app/api/backup/route.ts` to handle GET requests from Vercel cron jobs
  - Previously, the route only handled POST requests and returned "Method Not Allowed" for GET requests
  - Now both GET (cron jobs) and POST (manual) requests execute the same backup logic
  - The cron job in `vercel.json` will now work correctly with the daily backup schedule
- **Completed Page Title/Hero and CSS Fixes (July 26, 2024):**
  - User confirmed completion of page title and hero section implementation in `nextjs-app/app/[slug]/page.tsx`. This includes using the `PageHeader` component and leveraging fields like `showHero`, `hero`, `heading`, `title`, and `subheading` from the Sanity page schema.
  - User reported updates to `globals.css`, `theme.css`, and `nextjs-app/app/components/blocks/_classes.ts` to fix display issues related to nested themes.
- **Implemented Page Hero Section (July 25, 2024):**
  - User added `showHero` (boolean) and `hero` (image) fields to the page schema in `studio/src/schemaTypes/documents/page.ts`. (Assumed `heading`, `subheading` were also handled around this time).
  - Updated `getPageQuery` in `nextjs-app/sanity/lib/queries/page.ts` to include `showHero` and `hero{alt, asset->{url, metadata}}` (and likely `heading`, `subheading`).
  - User regenerated Sanity TypeScript types.
  - Modified `nextjs-app/app/[slug]/page.tsx` to:
    - Fetch the new hero fields.
    - Correctly type the `sanityFetch` call using `typeof getPageQuery`.
    - Conditionally render a hero image using `next/image` if `showHero` is true and the hero image asset exists.
    - The hero image is placed at the top of the content, uses `fill` and `object-cover`, and `priority`.
- **User Updated Page Schema in Sanity Studio (July 25, 2024):**
  - The user has made modifications to the page schema within the `studio/` directory. The specific changes (addition of `showHero` and `hero` fields) have been integrated.
- **Standardized Loading UI to Spinner (July 25, 2024):**
  - Replaced skeleton loaders with a consistent spinner UI across route-specific loading files.
  - Modified `nextjs-app/app/blog/loading.tsx`, `nextjs-app/app/[slug]/loading.tsx`, and `nextjs-app/app/blog/[slug]/loading.tsx` to use the `LoadingPage` component from `nextjs-app/app/components/ui/loading.tsx`.
  - The `LoadingPage` component (which uses a sub-component `Loading`) renders a centered spinner, providing a simpler and consistent loading state.
- **Implemented Footer Component with Settings and Navigation (July 25, 2024):**
  - Updated `nextjs-app/app/components/Footer.tsx` to be an `async` component.
  - It now fetches global site settings (title, logo) and footer navigation items using `sanityFetch` and the `settingsQuery`.
  - Resolved complex TypeScript issues with `sanityFetch` from `next-sanity`'s `defineLive`. The correct pattern is `const result = await sanityFetch<typeof settingsQuery>({ query: settingsQuery, ... }); const settings = result.data;`. The generic parameter is the type of the query string itself, and `next-sanity` infers the type of `result.data` (e.g., `SettingsQueryResult | null`).
  - Updated `nextjs-app/sanity/lib/queries/settings.ts` to include `siteLogo{alt, asset->{url, metadata}}` and `navigation.footer` with resolved page slugs and titles.
  - The footer now displays the site logo (if present), site title (if configured or no logo), and maps footer navigation items to `<Link>` components.
- **Fixed Linter Errors in `AdvancedListBlock.tsx` (July 25, 2024):**
  - Successfully resolved all linter errors in `nextjs-app/app/components/blocks/AdvancedListBlock.tsx`.
  - Applied `stegaClean` to `options.vAlign`.
  - Refactored image rendering to use `next/image` and `urlForImage` directly, addressing issues with `item.image.altText` and `item.heading`.
  - Removed problematic `SanityImageObject` import and used a generic fallback for image alt text.
- **Applied `stegaClean` to `CallToActionBlock.tsx` (July 25, 2024):**
  - Updated `nextjs-app/app/components/blocks/CallToActionBlock.tsx` to use `stegaClean` for the `options.vAlign` property within its `FormLayout` sub-component. The main `formDisplay` option was already using `stegaClean`.
- **Resolved Stega Frontend Error (July 25, 2024):** The significant frontend error "Failed to decode stega for string..." was investigated and confirmed resolved. The resolution is attributed to the systematic replacement of `stripChars` with `stegaClean` for block options and ensuring correct data handling.
- **Replaced `stripChars` with `stegaClean` in Multiple Blocks (July 25, 2024):**
  - The `stripChars` utility (previously in `nextjs-app/app/lib/stripChars.ts`) has been replaced with `stegaClean` from `@sanity/client/stega` in the following components to ensure consistent handling of steganography-encoded strings from Sanity, particularly for block options:
    - `nextjs-app/app/components/blocks/BlockRenderer.tsx`
    - `nextjs-app/app/components/blocks/TestimonialBlock.tsx`
    - `nextjs-app/app/components/blocks/ContentBlock.tsx`
    - `nextjs-app/app/components/blocks/BlockBGColor.tsx`
    - `nextjs-app/app/components/blocks/GalleryBlock.tsx`
  - The file `nextjs-app/app/lib/stripChars.ts` was deleted.
- **Fixed `GridCols` Indexing in `BentoBlock.tsx` (July 25, 2024):**
  - Resolved a TypeScript linter error in `nextjs-app/app/components/blocks/BentoBlock.tsx` by changing `GridCols['3']` to `GridCols.three` to correctly reference the enum key defined in `nextjs-app/app/components/blocks/_classes.ts`.
- **Updated Sanity Image Query for `carouselBlock` (July 25, 2024):**
  - In `nextjs-app/sanity/lib/queries/common.ts`, modified the `pageBuilder` query for `_type == "carouselBlock"` to fetch image assets consistently. Changed `images[]{ ..., image{ ..., image{ ..., asset-> } } }` to `images[]{ ..., image{ ..., asset-> } }`.
- **Refactored `OptimizedImage` to `next/image` and `urlForImage` (July 24, 2024):**
  - Systematically replaced all usages of `OptimizedImage.tsx` across the `nextjs-app/` codebase with `next/image` from `next/image` and the `urlForImage` utility from `nextjs-app/sanity/lib/image.ts`.
  - This involved:
    - Reading each component that used `OptimizedImage`.
    - Applying a detailed strategy for prop conversion:
      - `src` for `next/image` generated by `urlForImage`.
      - `urlForImage` dimensions: Explicit `width`/`height` from `OptimizedImage` if present, otherwise no dimensions.
      - `next/image` dimensions: `fill={true}` if `OptimizedImage` had `fill`. Otherwise, explicit `width`/`height` from `OptimizedImage` or original Sanity asset dimensions.
      - Transferred `alt`, `priority`, `loading`, `sizes` props.
      - Handled `className` (wrapper for `fill={true}`, direct for fixed).
      - Replaced `objectFit` prop with Tailwind classes (e.g., `object-cover`, `object-contain`).
  - Refactored `nextjs-app/app/components/SanityImage.tsx` (which was a wrapper for `OptimizedImage`) to be a direct wrapper for `next/image` incorporating the `urlForImage` logic and prop handling.
  - Deleted the `nextjs-app/app/components/ui/optimized-image.tsx` file.
  - Addressed and fixed a "legacy prop objectFit" warning by moving `objectFit` to Tailwind classes in all affected components and `SanityImage.tsx`.
- **Fixed PortableText List Item Rendering (July 24, 2024):**
  - Investigated `[@portabletext/react] Unknown list item style "bullet"` error.
  - Initially attempted to fix by adding `list` and `listItem` component definitions to `nextjs-app/app/components/blocks/index.tsx`. This did not resolve the issue.
  - Identified the root cause in the Sanity Studio schema.
  - Added `styles` (for `normal`, `h1`-`h6`, `blockquote`) and `lists` (for `bullet`, `number`) definitions to the `array.of` field in `studio/src/schemaTypes/objects/blockContent.tsx`. This resolved the rendering error.
- **Successfully Unified Image Handling (July 22, 2024):**
  - Refactored all identified block components (`LogoParadeBlock.tsx`, `ImageGridBlock.tsx`, `SlideshowBlock.tsx`, `TestimonialBlock.tsx`, `FeaturesCard.tsx`, `AdvancedListBlock.tsx`, `FeaturesDefault.tsx`) to use `OptimizedImage.tsx` and the `urlForImage` utility from `nextjs-app/sanity/lib/image.ts`.
  - This completed the refactoring previously done for `Avatar.tsx`, `Header.tsx`, `PostList.tsx`, `GalleryBlock.tsx`, and `HeroBlock.tsx`.
  - OpenGraph image generation in `app/[slug]/page.tsx` and `app/blog/page.tsx` was also updated to use `urlForImage`.
  - `OptimizedImage.tsx` was updated to correctly handle `fill` prop in conjunction with `width`, `height`, and `objectFit` to ensure images display as intended (e.g., "contain" for logos, "cover" for cards) without being stretched or cropped incorrectly by Sanity.
  - Confirmed `OptimizedImage.tsx` includes `"use client";`.
  - Confirmed `urlForImage` in `nextjs-app/sanity/lib/image.ts` is client-safe and does not import the main Sanity `client`.
  - Verified with `npm run build` in `nextjs-app/` which completed successfully.
- **Added `next.config.mjs` for Image Optimization (July 23, 2024):**
  - Created `nextjs-app/next.config.mjs`.
  - Configured `images.deviceSizes` with more granular values `[320, 375, 425, 500, 640, 750, 828, 1080, 1200, 1920]` to improve image loading on mobile devices.
  - Included default `imageSizes` and remote pattern for Sanity CDN.
- **Updated `Heading.tsx` to Fix Deprecated API Warning (July 23, 2024):**
  - Added default Tailwind CSS font size classes (e.g., `text-4xl sm:text-5xl lg:text-6xl` for `<h1>`) to `nextjs-app/app/components/Heading.tsx` for levels 1-6.
  - Added a default case to the `level` switch to handle invalid inputs gracefully.
- **Implemented Security Headers via Middleware (July 23, 2024):**
  - Created `nextjs-app/middleware.ts`.
  - Configured Content-Security-Policy (CSP) to support Sanity Live Preview, YouTube embeds, and general best practices (using nonces, `'strict-dynamic'`).
  - Added other security headers: `X-Content-Type-Options`, `X-Frame-Options`, `X-XSS-Protection`, `Referrer-Policy`, `Permissions-Policy`.
  - Noted that nonce propagation to individual script tags is a required follow-up for full `script-src` CSP enforcement.
- **Refined Security Headers in Middleware (July 23, 2024):**
  - Removed `X-Frame-Options` from `nextjs-app/middleware.ts` to rely on CSP `frame-ancestors` for better compatibility with Sanity Live Preview iframing.
  - Updated fallback `sanityProjectId` in middleware based on console log information.
- **Updated `.cursorrules` (July 23, 2024):** Added a new rule under "Workspace Structure (CRITICAL)" to require explicit user permission before making changes to files in a non-target workspace.
- User reverted page-level changes related to the "Unify image URL implementations" task.
- Applied edits to ensure `OptimizedImage.tsx` includes `"use client";` and `urlForImage` in `lib/image.ts` is client-safe (no main `client` import) and has logging. Latest logs (prior to reversion) showed `urlForImage` generating URLs successfully on client and server.
- Attempted to unify Sanity image URL generation and `next/image` usage (now reverted by user).
- Refactored several components (`GalleryBlock`, `HeroBlock`, `PostList`, `Avatar`, `Header`) to use a centralized `SanityImage` wrapper.
- Added `"use client";` to `OptimizedImage.tsx` due to hook usage.
- Added extensive logging to `OptimizedImage.tsx` and `urlForImage` in `lib/image.ts` to trace image object and URL generation.
- Updated `progress.md` to reflect the reverted status of image unification.
- **Implemented Sanity recycling bin functionality for document recovery**
  - Added `deletedDocs.bin` singleton document type
  - Set up webhook for deletion tracking
  - Implemented custom UI components for recovery interface
  - Added document restoration capabilities
  - Created dedicated view for managing deleted documents
  - Implemented GROQ delta functions for operation filtering
  - Added custom components:
    - `DeletionLogItemComponent` for individual log entries
    - `DeletionLogInputComponent` for logs array management
    - `DeletedDocIdInputComponent` for ID display
  - Integrated user authentication for deletion tracking
  - Added automatic cleanup of restored documents

## Recent Learnings

- **CSS Specificity with Nested Themes:** Custom CSS (`globals.css`, `theme.css`) and utility classes (`_classes.ts`) may require careful management to ensure correct styling an display, especially when dealing with nested theme structures or dynamically applied theme classes.
- **Centralized Loading Components:** Utilizing a common loading component (like `LoadingPage` in `components/ui/loading.tsx`) for route-level loading states (`loading.tsx` files) ensures a consistent user experience during navigation and data fetching.
- **`sanityFetch` (from `next-sanity` `defineLive`) Typing:** The generic parameter `T` in `sanityFetch<T>(options)` should be the type of the query string itself (e.g., `typeof yourQueryVariable`). `next-sanity`, in conjunction with types generated by `sanity-typegen` (specifically the `SanityQueries` interface in `sanity.types.ts`), then infers the structure of the returned object, which typically includes a `data` property (e.g., `YourQueryVariableResult | null`), `sourceMap`, and `tags`. Access the actual query result via `result.data`. This was crucial for resolving typing issues in `Footer.tsx`.
- **`stegaClean` for Block Options:** Using `stegaClean` from `@sanity/client/stega` is the correct approach for handling potentially steganography-encoded strings coming from Sanity fields used for options (e.g., `textAlign`, `blockTheme`, `columns`). This ensures that the actual string value is retrieved for logic or mapping to CSS classes, while preserving the steganography data for visual editing purposes if the raw string were to be rendered directly. Replacing custom utilities like `stripChars` with `stegaClean` improves consistency and leverages Sanity's intended mechanisms.
- **Enum Key Access:** When accessing TypeScript enums (or similar constant objects), ensure the key used (e.g., `GridCols.three`) matches the exact key defined in the enum (`three`), not a potential value or a different string representation (like `'3'`).
- **Sanity GROQ Image Projections:** Maintain consistency in how image assets are projected in GROQ queries (e.g., `image{ ..., asset-> }`). Inconsistent nesting (like an extra `image` field) can lead to issues when the frontend tries to access `asset._ref`.
- **PortableText Component Resolution:** Errors like "Unknown list item style" for PortableText can originate from missing style/list definitions in the Sanity schema (`blockContent.tsx` in this case) even if frontend components are defined. The schema dictates what styles are available to the editor and for serialization.
- **`next/image` `objectFit` Handling:** The `objectFit` prop is deprecated on `next/image`. Styling for `object-fit` (e.g., `cover`, `contain`) must be applied via Tailwind CSS classes to the `className` prop of the `next/image` component (or its wrapper if `fill={true}`).
- **Refactoring Large-Scale UI Components:** A systematic approach is crucial:
  - Define a clear strategy for prop mapping and behavior changes.
  - Address one component/file at a time.
  - Handle potential `null` or `undefined` values for image sources or URLs, especially when using `urlForImage`.
  - Test and fix linter errors incrementally.
  - Be prepared to read related utility/component definitions (e.g., `urlForImage`, the component being replaced) to understand their exact behavior.
- **Workspace Integrity (CRITICAL):** Added a rule to `.cursorrules` to ensure I do not modify files in a non-target workspace (e.g., `studio/` if working in `nextjs-app/`) without explicit permission. This is vital to prevent unintended side effects and maintain project stability.
- **CSP for Sanity Live Preview & YouTube:** Requires careful configuration of `frame-ancestors`, `connect-src`, `script-src`, `img-src`, `media-src`, and `child-src` to allow communication with Sanity APIs, CDNs, and YouTube services, while also enabling iframing for the Studio.
- **Nonce-based CSP:** While `middleware.ts` can generate a nonce and set the CSP header, the nonce must also be applied to all `<script>` tags in the application for `script-src 'nonce-...'` to be effective. This requires further integration with Next.js page/app rendering.
- **X-Frame-Options vs CSP `frame-ancestors`:** `X-Frame-Options: SAMEORIGIN` can conflict with `frame-ancestors` when trying to allow specific cross-origin framing (like Sanity Studio). Removing XFO and relying on `frame-ancestors` is often preferred.
- **Sanity Visual Editing Errors:** Console errors like "Unable to post message. Recipient has origin null" and "Unable to connect to visual editing" often point to issues with the JavaScript setup of `@sanity/visual-editing` in the frontend application or misconfiguration in the Sanity Studio's `presentationTool` settings, rather than purely CSP issues (once basic framing is allowed).
- **`OptimizedImage.tsx` `fill` prop behavior:** When `fill={true}` is used with `OptimizedImage.tsx`:
  - Explicit `width` and `height` props passed to `OptimizedImage` should _only_ be passed to `urlForImage` if a specific cropped version from Sanity is desired.
  - If `width` and `height` are _not_ passed to `OptimizedImage` (while `fill={true}`), then `urlForImage` should be called _without_ dimensions. This allows `next/image` (with `fill` and `sizes` prop) to handle responsive scaling of the natural image from Sanity, preventing unintended cropping by Sanity based on default or prior dimensions.
  - The `objectFit` prop on `OptimizedImage` (e.g., "contain", "cover") correctly controls the `object-fit` style on the internal `next/image` component, crucial for images used with `fill={true}`.
  - The parent container of an `OptimizedImage` using `fill={true}` needs relative positioning and appropriate dimensions for the image to fill correctly.
- **Sanity Client/Utilities in Client Components**: Extreme care must be taken. The primary concern is exposing server-only tokens/secrets if a full Sanity client instance (from `lib/client.ts`) were used directly for data fetching in a Client Component.
- **`urlForImage` safety**: The `urlForImage` utility in `lib/image.ts` _is_ client-safe for URL generation if `projectId` and `dataset` (from `lib/api.ts`) are correctly sourced from `NEXT_PUBLIC_` environment variables and are valid, and it does _not_ import the main data-fetching Sanity client from `lib/client.ts`.
- **"Token in browser" warning**: This Sanity warning often originates from live preview/editing functionalities (e.g., `defineLive` using the main client) and might be a separate concern from basic image URL generation using `urlForImage`.
- The previous issue where images were not displaying (despite `urlForImage` logs showing URL generation) after refactoring needs to be carefully investigated during the restart, potentially relating to how `next/image` consumed the URL or props in `OptimizedImage`.
- Route creation is restricted to project maintainers.
- All routes must be documented in memory bank before implementation.
- **Sanity's intent routing for document restoration**
- **GROQ delta functions for operation filtering**
- **Component API for custom UI elements**
- **Studio structure customization**
- **Webhook configuration best practices**
- **User authentication integration**
- **Automatic document cleanup**
- **Date formatting utilities**
- **GROQ query optimization**
- **Custom input component development**

## Next Steps

- **Verify Overall Stability:** After the recent page hero/title and CSS changes, perform a general check of the application.
- **Update Memory Bank:** Ensure all Memory Bank files are fully up-to-date with the schema changes and any subsequent code adjustments.
- **Address Remaining Known Issues (Lower Priority for now):**
  - Debug `@sanity/visual-editing` integration ("Unable to connect" errors).
  - Implement nonce propagation for CSP.
  - Investigate and resolve the "token in browser" warning from Sanity.
- **Test document recovery workflow**
- **Monitor webhook performance**
- **Gather feedback on recovery interface**
- **Consider additional recovery features**
- Implement additional UI improvements
- Add more detailed document metadata
- Consider batch restore functionality
- Add filtering and search capabilities
- Optimize GROQ queries
- Enhance user authentication integration
- Improve date formatting and display
- Add more detailed logging
- **Verify Webhook Creation**
  - Test webhook creation using Sanity CLI
  - Verify webhook functionality
  - Monitor webhook logs
  - Test document deletion tracking
- **Webhook Creation**
  - Research correct Sanity CLI approach
  - Verify CLI documentation
  - Test CLI commands manually before scripting
  - Update script to use CLI if confirmed working

## Active Decisions

1. Architecture

   - Using Next.js 15 with App Router
   - Implementing Sanity Studio for CMS
   - Following component-based architecture
   - Utilizing real-time capabilities

2. Development

   - TypeScript for type safety
   - Tailwind CSS for styling
   - Modular component structure
   - Real-time content updates

3. SEO

   - Using Schema.org BreadcrumbList format for structured data
   - Implementing structured data via Next.js Script component
   - Using environment variables for site URL configuration

## Current Considerations

1. Technical

   - Performance optimization
   - SEO requirements
   - Accessibility standards
   - Security measures

2. User Experience

   - Content editing workflow
   - Preview capabilities
   - Responsive design
   - Loading states

3. Route Management
   - Route creation restrictions
   - Documentation requirements

## Technical Considerations

- Need to ensure NEXT_PUBLIC_SITE_URL is properly configured
- Structured data should be validated against Schema.org guidelines
- Consider implementing dynamic structured data for different page types

## Open Questions

- Should we add more structured data types beyond breadcrumbs?
- How can we better integrate structured data with dynamic content?
- What other SEO enhancements should we prioritize?

## Current Focus

- Document recovery system implementation
- Webhook configuration and testing
- UI/UX improvements for recovery interface
- Custom component development
- Studio structure customization
- Integration with Sanity's Component API
- User authentication integration
- Automatic document cleanup
- Date formatting and display
- GROQ query optimization

## Known Issues & Non-Working Approaches

- **Webhook Creation via API Calls**
  - Direct API calls to create webhooks do not work
  - Attempted endpoints:
    - `https://api.sanity.io/v2021-06-07/projects/{projectId}/webhooks`
    - `https://api.sanity.io/v2021-03-25/projects/{projectId}/webhooks`
    - `https://api.sanity.io/v2025-05-06/projects/{projectId}/webhooks`
  - All attempts result in 404 errors
  - API calls should not be used for webhook creation
  - Must use Sanity CLI instead
